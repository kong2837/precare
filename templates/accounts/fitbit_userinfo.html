{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <a class="btn btn-secondary mb-2" href="javascript:history.go(-1)">목록으로</a>

  <div class="card">
    <div class="card-body">
      <div class="d-flex w-100 justify-content-between">
        <h3 class="card-title">{{ userInfo.fitbit.full_name|default:userInfo.username }}</h3>
        <small>마지막 동기화: {{ userInfo.fitbit.last_synced }}</small>
      </div>

      <form action="{% url 'accounts:updateNote' userInfo.pk %}" method="post" class="mt-3">
        {% csrf_token %}
        <div class="form-group">
          <label for="note">참고사항</label>
          <textarea class="form-control" id="note" rows="5" name="note">{{ userInfo.fitbit.note }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-2">수정하기</button>
      </form>
    </div>

   <!-- 스트레스 점수 -->
    <div class="card-body border-top">
      <h4 class="mt-1">스트레스 점수</h4>

      <!-- 탭 -->
      <ul class="nav nav-tabs" id="stressTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link chart-link active" data-range="weekly" type="button" aria-selected="true">주간</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link chart-link" data-range="monthly" type="button" aria-selected="false">월간</button>
        </li>
      </ul>

      <div class="mt-3" id="stressWrap" style="height:360px;">
        <canvas id="stressWeekly"></canvas>
        <canvas id="stressMonthly" class="d-none"></canvas>
        <p id="stressEmpty" class="text-muted small d-none">표시할 설문 데이터가 없습니다.</p>
      </div>
    </div>

<!-- 탭 글자색을 항상 검정으로 강제 -->
<style>
  #stressTabs .chart-link,
  #stressTabs .chart-link:hover,
  #stressTabs .chart-link:focus,
  #stressTabs .chart-link.active{
    color:#000 !important;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const uid  = Number("{{ userInfo.pk }}");
  const base = "{% url 'accounts:stress_data_chart' 0 %}".replace('/0/', `/${uid}/`);

  const tabs        = document.querySelectorAll('#stressTabs .chart-link');
  const weeklyCV    = document.getElementById('stressWeekly');
  const monthlyCV   = document.getElementById('stressMonthly');
  const emptyEl     = document.getElementById('stressEmpty');

  let charts = { weekly: null, monthly: null };
  let scaleMax = 40;

  function drawLine(canvas, key, labels, values){
    if (charts[key]) charts[key].destroy();
    charts[key] = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: '스트레스 점수',
          data: values,
          tension: 0.2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        spanGaps: true, 
        scales: { y: { beginAtZero: true, max: scaleMax } },
        plugins: { legend: { display: true } }
      }
    });
  }

  async function loadWeeklySeries(){
    const res = await fetch(`${base}?range=weekly`, { credentials: "same-origin" });
    if (!res.ok){
      console.error('HTTP', res.status);
      emptyEl.textContent = '차트를 불러오는 중 문제가 발생했습니다.';
      emptyEl.classList.remove('d-none');
      return;
    }
    const data = await res.json();
    scaleMax = data?.meta?.scale_max ?? 40;

    const labels = data.labels || [];
    const values = data.values || [];
    const hasData = values.length > 0;
    emptyEl.classList.toggle('d-none', hasData);
    weeklyCV.classList.toggle('d-none', !hasData);
    monthlyCV.classList.add('d-none');

    if (!hasData){
      if (charts.weekly) charts.weekly.destroy();
      return;
    }
    drawLine(weeklyCV, 'weekly', labels, values);
  }

  async function loadMonthly(){
    const res = await fetch(`${base}?range=monthly`, { credentials: "same-origin" });
    if (!res.ok){
      console.error('HTTP', res.status);
      emptyEl.textContent = '차트를 불러오는 중 문제가 발생했습니다.';
      emptyEl.classList.remove('d-none');
      return;
    }
    const data = await res.json();
    scaleMax = data?.meta?.scale_max ?? scaleMax;

    const labels = data.labels || [];
    const values = data.values || [];
    const hasData = values.length > 0;

    emptyEl.classList.toggle('d-none', hasData);
    monthlyCV.classList.toggle('d-none', !hasData);
    weeklyCV.classList.add('d-none');

    if (!hasData){
      if (charts.monthly) charts.monthly.destroy();
      return;
    }
    drawLine(monthlyCV, 'monthly', labels, values);
  }

  function activate(range){
    tabs.forEach(b => {
      const on = (b.dataset.range === range);
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });

    if (range === 'weekly') {
      loadWeeklySeries();
    } else {
      loadMonthly();
    }
  }

  tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.range)));
  // 최초: 주간(주 단위) 로드
  activate('weekly');
})();
</script>

{% endblock %}
