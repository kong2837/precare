{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <a class="btn btn-secondary mb-2" href="javascript:history.go(-1)">목록으로</a>

  <div class="card">
    <div class="card-body">
      <div class="d-flex w-100 justify-content-between">
        <h3 class="card-title">{{ userInfo.huami.full_name }}</h3>
        <small>마지막 동기화: {{ userInfo.huami.sync_date }}</small>
      </div>

      <div class="row">
        <label for="userId" class="col-sm-2 col-form-label">유저아이디</label>
        <div class="col-sm-4">
          <input type="text" readonly class="form-control-plaintext" id="userId"
                 value="{% if userInfo.fitbit.full_name %}{{ userInfo.fitbit.full_name }}{% else %}{{ userInfo.username }}{% endif %}">
        </div>

        <label for="email" class="col-sm-2 col-form-label">Email</label>
        <div class="col-sm-4">
          <input type="text" readonly class="form-control-plaintext" id="email"
                 value="{{ userInfo.huami.email }}">
        </div>
        <hr>
      </div>

      <form action="{% url 'accounts:updateNote' userInfo.pk %}" method="post">
        {% csrf_token %}
        <div class="form-group">
          <label for="note">참고사항</label>
          <textarea class="form-control" id="note" rows="5" name="note">{{ userInfo.huami.note }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-2">수정하기</button>
      </form>
    </div>

    <!-- 스트레스 점수 -->
    <div class="card-body border-top">
      <h4 class="mt-1">스트레스 점수</h4>

      <!-- 탭: chart-link 클래스로 사용 (nav-link도 함께 주면 부트스트랩 탭 스타일 유지) -->
      <ul class="nav nav-tabs" id="stressTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link chart-link active" data-range="weekly" type="button" aria-selected="true">주간</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link chart-link" data-range="monthly" type="button" aria-selected="false">월간</button>
        </li>
      </ul>

      <div class="mt-3" id="stressWrap" style="height:360px;">
        <canvas id="stressWeekly"></canvas>
        <canvas id="stressMonthly" class="d-none"></canvas>
        <p id="stressEmpty" class="text-muted small d-none">표시할 설문 데이터가 없습니다.</p>
      </div>
    </div>
  </div>
</div>

<!-- 탭 글자색을 항상 검정으로 강제 -->
<style>
  #stressTabs .chart-link,
  #stressTabs .chart-link:hover,
  #stressTabs .chart-link:focus,
  #stressTabs .chart-link.active{
    color:#000 !important;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const uid = Number("{{ userInfo.pk }}");
  const base = "{% url 'accounts:stress_data_chart' 0 %}".replace('/0/', `/${uid}/`);

  const tabs          = document.querySelectorAll('#stressTabs .chart-link');
  const weeklyCanvas  = document.getElementById('stressWeekly');
  const monthlyCanvas = document.getElementById('stressMonthly');
  const emptyEl       = document.getElementById('stressEmpty');

  let charts = {};

  async function loadChart(range) {
    const res = await fetch(`${base}?range=${range}`, { credentials: "same-origin" });
    if (!res.ok) {
      console.error('HTTP', res.status);
      emptyEl.textContent = '차트를 불러오는 중 문제가 발생했습니다.';
      emptyEl.classList.remove('d-none');
      return;
    }
    const data = await res.json();

    const target  = (range === 'weekly') ? weeklyCanvas : monthlyCanvas;
    const hasData = Array.isArray(data.values) && data.values.length > 0;

    emptyEl.classList.toggle('d-none', hasData);

    if (charts[range]) charts[range].destroy();
    if (!hasData) return;

    charts[range] = new Chart(target.getContext('2d'), {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [{
          label: '스트레스 점수',
          data: data.values,
          tension: 0.2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        spanGaps: false, // weekly의 null을 갭으로
        scales: {
          y: { beginAtZero: true, max: 30 }
        },
        plugins: { legend: { display: true } }
      }
    });
  }

  function activate(range){
    tabs.forEach(b => {
      const on = (b.dataset.range === range);
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });
    weeklyCanvas.classList.toggle('d-none', range !== 'weekly');
    monthlyCanvas.classList.toggle('d-none', range !== 'monthly');
    emptyEl.classList.add('d-none');
    loadChart(range);
  }

  tabs.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.range)));
  activate('weekly');
})();
</script>
{% endblock %}
